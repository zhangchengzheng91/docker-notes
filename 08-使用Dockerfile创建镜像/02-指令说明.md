# 指令说明

Dockerfile 中指令的一般格式为 INSTRUCTION ATGUMENTS，包括 "配置指令"（配置镜像信息） 和 "操作指令"（具体执行操作）。

配置指令：

## ARG

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| ARG | 定义创建镜像过程中使用的变量 | ARG <name>[=\<default value>] |

在执行 docker build 时，可以通过 --build-arg [=] 来为变量赋值。当镜像编译成功后，ARG 指定的变量将不再存在（ENV 指定的变量将在镜像中保留）。

Docker 内置了一些镜像创建变量，用户可以直接使用无须声明，包括（不区分大小写）HTTP_PROXY、HTTPS_PROXY、FTP_PROXY、NO_PROXY。


## FROM

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| FROM | 制定所创建镜像的基础镜像 | FROM \<image> <br/> FROM \<image>:\<tag> \[AS \<name>] <br/> FROM \<image>@\<digest> \[AS name] |

任何 Dockerfile 中的第一条指令必须为 FROM 命令。并且，如果在同一个 Dockerfile 中创建多个镜像时，可以使用多个 FROM 指令（每个镜像一次）。

为了保证镜像精简，可以选用体积较小的镜像如 Alpine 或 Debian 作为基础镜像。例如：

```dockerfile
ARG VERSION=9.3
FROM Debian:${VERRISON}
```

## LABEL

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| LABEL | 为生成的镜像添加元数据标签信息 | LABEL \<key>=\<valye> \<key>=\<valye> \<key>=\<valye> ... |

这些信息可以用来辅助过滤出特定镜像。

```dockerfile
LABEL version="1.0.0-rc3"
LABEL author="yeasy@github" date="2020-01-01"
LABEL description="This text illustrates \
	that label-values can span multiple lines."
```

## EXPOSE

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| EXPOSE | 声明镜像内服务监听端口 | EXPOSE \<port> [\<port>/\<protocal>...] |

注意该指令只是起到声明作用，并不会自动完成端口映射。

如果要端口映射出来，在容器启动时可以使用 -P 或 -p HOST_PORT:CONTAINER_PORT。

```dockerfile
EXPOSE 22 80 8443
```

## ENV

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| ENV | 指定环境变量，在镜像生成过程中会被后续 RUN 指令使用 ，在镜像启动的容器中也会存在 | ENV \<key> \<value> <br/> ENV \<key>=\<value>... |

```dockerfile
ENV APP_VERSION=1.0.0
ENV APP_HOME=/usr/local/app
ENV PATH $PATH:/usr/local/bin
```

指令注定的环境变量在运行时可以被覆盖掉，如 docker run --env \<key>=\<value> built_image.

注意当一条 ENV 指令中同时为多个环境变量赋值并且值也是从环境变量读取时，会为变量都赋值后再更新。

````dockerfile
ENV key1=value2
ENV key1=value1 key2=${key1}
# key1=value1 key2=value2
````

## ENTRYPOINT

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| ENTRYPOINT | 指定镜像的默认入口命令，该入口命令会在启动容器时作为根命令执行，所有传入值作为该命令参数 | ENTRYPOINT \["executable", "param1", "param2"] : exec 调用执行 <br/> ENTRYPOINT command param1 param2 : shell 中执行 |

此时，CMD 指令指定值将作为根命令的参数

每个 Dockerfile 中只能有一个 ENTRYPOINT，当指定多个时，只有最后一个起效。
在运行时，可以被 --entrypoint 参数覆盖掉，如 docker run --entrypoint。

## VOLUME

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| VOLUME | 创建一个数据卷挂载点 | VOLUME \["/data"] |

运行容器时可以从本地主机或其他容器挂载数据卷，一般用来存放数据库和需要保持的数据等。

## USER

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| USER | 指定运行容器时的用户名或 UID，后续的 RUN 等指令也会使用指定的用户身份 | USER daemon |

当服务不需要管理员权限时，可以通过该命令指定运行用户，并且在 Dockerfile 中创建所需要的用户。例如：

```dockerfile
RUN groupadd -r postgres && useradd --no-log-init -r -g postgres postgres
```

要临时获取管理员权限可以使用 gosu 命令。

## WORKDIR

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| WORKDIR | 为后续的 RUN、CMD、ENTRYPOINT 指令配置工作目录 | WORKDIR /path/to/workdir |

可以使用多一个 WORKDIR 命令，后续命令如果参数是相对路径，则会基于之前命令指定的路径。例如：

```dockerfile
WORKDIR /a
WORKDIR b
WORKDIR c
RUN pwd

# 则最终路径为 /a/b/c
```

因此，为了避免出错，推荐 WORKDIR 指令中只使用绝对路径。

## ONBUILD

| 指令 | 说明 | 格式 |
|:---|:---|:---|
| ONBUILD | 创建子镜像时指定自动执行的操作指令 ||


| STOPSINGLE | 指定退出的信号值 | |
| HEALTHCHECK | 配置所启动容器如何进行健康检查 ||
| SHELL | 指定默认 shell 类型 ||

操作指令：

| 指令 | 说明 | 备注 |
|:---|:---|:---|
| RUN | 运行指定命令 | |
| CMD | 启动容器时指定默认执行的命令 | |
| ADD | 添加内容到镜像 | |
| COPY | 复制内容到镜像 | |
